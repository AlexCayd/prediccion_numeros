<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png" />
    <title>Números</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      :root{
        --bg-1: #0f1226;
        --bg-2: #11162e;
        --card-bg: rgba(255,255,255,0.06);
        --stroke: rgba(255,255,255,0.12);
        --txt: #e8eaf6;
        --muted: #b6b9d6;
        --primary: #7c5cff;
        --primary-2: #22d3ee;
      }

      body{
        min-height: 100vh;
        color: var(--txt);
        background:
          radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,0.25), transparent 60%),
          radial-gradient(900px 600px at 110% 10%, rgba(34,211,238,0.18), transparent 55%),
          linear-gradient(180deg, var(--bg-1), var(--bg-2));
      }

      .page-header{
        border: none !important;
        padding-top: 2.25rem !important;
        padding-bottom: 1.25rem !important;
        text-align: center;
      }

      /* Título con degradado */
      .gradient-title{
        font-weight: 800;
        letter-spacing: .3px;
        background: linear-gradient(135deg, #ffffff 20%, #b8c0ff 45%, #7c5cff 70%, #22d3ee 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 6px 28px rgba(124,92,255,.25);
      }

      .glass-card{
        background: var(--card-bg);
        border: 1px solid var(--stroke);
        border-radius: 1.25rem;
        backdrop-filter: blur(10px);
      }

      .panel-title{
        font-weight: 700;
        letter-spacing: .3px;
      }
      .panel-sub{ color: var(--muted); }

      /* Layout: canvas a la izquierda, resultado a la derecha */
      .draw-area{
        display: grid;
        grid-template-columns: 200px minmax(140px,1fr);
        gap: 5rem;
        align-items: center;
      }

      #canvas-container{
        position: relative;
        padding: .5rem;
        border-radius: 1rem;
        border: 1px dashed var(--stroke);
      }

      /* Canvas fondo BLANCO como el original */
      #bigcanvas{
        display:block;
        margin: 0 auto;
        border-radius: .75rem;
        border: 1px solid var(--stroke);
        background: #ffffff;            /* ← blanco */
        box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 8px 24px rgba(0,0,0,.35);
        cursor: crosshair;
      }

      .hint{ font-size:.95rem; color:var(--muted); }

      /* Resultado al lado del canvas */
      .result-wrap{
        display:flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        border: 1px solid var(--stroke);
        border-radius: .75rem;
        padding: .5rem .75rem;
        background: rgba(255,255,255,.04);
        backdrop-filter: blur(6px);
      }
      .result-label{
        color: var(--muted);
        font-size: .9rem;
        margin-bottom: .25rem;
      }
      #resultado{
        font-weight: 900;
        font-size: clamp(3rem, 6vw + 1rem, 6rem);
        line-height: 1;
        text-align: center;
        letter-spacing: .02em;
        background: linear-gradient(135deg, #fff, #bfc5ff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 6px 32px rgba(124,92,255,.25);
      }

      .btn-modern{
        border-radius: .8rem;
        border: 1px solid var(--stroke);
        padding: .7rem 1rem;
        backdrop-filter: blur(6px);
        transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      }
      .btn-modern:focus{
        outline: none;
        box-shadow: 0 0 0 .25rem rgba(124,92,255,.25);
      }
      .btn-clean{
        background: rgba(255,255,255,.04);
        color: var(--txt);
      }
      .btn-clean:hover{
        transform: translateY(-1px);
        border-color: rgba(255,255,255,.25);
        box-shadow: 0 10px 24px rgba(0,0,0,.25);
      }
      .btn-predict{
        background: linear-gradient(135deg, var(--primary), var(--primary-2));
        color: #0b0f24;
        font-weight: 700;
      }
      .btn-predict:hover{
        transform: translateY(-1px) scale(1.01);
        box-shadow: 0 14px 28px rgba(124,92,255,.35);
      }

      /* Responsive: si la pantalla es muy estrecha, que se apile */
      @media (max-width: 480px){
        .draw-area{ grid-template-columns: 1fr; }
        .result-wrap{ min-height: 120px; }
      }
    </style>
  </head>
  <body>
    <main class="container py-4">
      <header class="page-header">
        <h1 class="display-6 gradient-title mb-1">Números escritos a mano</h1>
      </header>

      <section class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <div class="glass-card p-4 p-md-5">
            <h2 class="panel-title h5 mb-3">Dibuja y predice</h2>
            <p class="hint mb-4">
              Dibuja el número <strong>grande</strong> y <strong>centrado</strong> para obtener una mejor predicción. Usa el botón “Limpiar” para volver a intentar.
            </p>

            <!-- Canvas a la izquierda y resultado a la derecha -->
            <div class="draw-area mb-3">
              <div id="canvas-container">
                <canvas id="bigcanvas" width="200" height="200" aria-label="Lienzo para dibujar un número"></canvas>
                <canvas id="smallcanvas" width="28" height="28" style="display:none;"></canvas>
              </div>

              <div class="result-wrap">
                <div class="result-label">Resultado</div>
                <div id="resultado" aria-live="polite"></div>
              </div>
            </div>

            <div class="d-flex gap-2 justify-content-center">
              <button class="btn btn-modern btn-clean" id="limpiar" onclick="limpiar()" title="Borrar el lienzo">
                <i class="bi bi-eraser me-1"></i> Limpiar
              </button>
              <button class="btn btn-modern btn-predict" id="predecir" onclick="predecir()" title="Ejecutar predicción">
                <i class="bi bi-magic me-1"></i> Predecir
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- JS (sin cambios en tu lógica) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <script src="fabric.min.js"></script>
    <script src="drawing.js"></script>

    <script type="text/javascript">
      /* === Tu JS sin modificar === */
      var modelo = null;

      var canvas = document.getElementById("bigcanvas");
      var ctx1 = canvas.getContext("2d");
      var smallcanvas = document.getElementById("smallcanvas");
      var ctx2= smallcanvas.getContext("2d");

      function limpiar() {
          ctx1.clearRect(0, 0, canvas.width, canvas.height);
          drawingcanvas.clear();
      }

      function predecir() {
            resample_single(canvas, 28, 28, smallcanvas);
            var imgData = ctx2.getImageData(0,0,28,28);
            var arr = [];
            var arr28 = [];
            for (var p=0, i=0; p < imgData.data.length; p+=4) {
                var valor = imgData.data[p+3]/255;
                arr28.push([valor]);
                if (arr28.length == 28) {
                    arr.push(arr28);
                    arr28 = [];
                }
            }
            arr = [arr];
            var tensor4 = tf.tensor4d(arr);
            var resultados = modelo.predict(tensor4).dataSync();
            var mayorIndice = resultados.indexOf(Math.max.apply(null, resultados));
            console.log("Prediccion", mayorIndice);
            document.getElementById("resultado").innerHTML = mayorIndice;
      }

      function resample_single(canvas, width, height, resize_canvas) {
          var width_source = canvas.width;
          var height_source = canvas.height;
          width = Math.round(width);
          height = Math.round(height);

          var ratio_w = width_source / width;
          var ratio_h = height_source / height;
          var ratio_w_half = Math.ceil(ratio_w / 2);
          var ratio_h_half = Math.ceil(ratio_h / 2);

          var ctx = canvas.getContext("2d");
          var ctx2 = resize_canvas.getContext("2d");
          var img = ctx.getImageData(0, 0, width_source, height_source);
          var img2 = ctx2.createImageData(width, height);
          var data = img.data;
          var data2 = img2.data;

          for (var j = 0; j < height; j++) {
              for (var i = 0; i < width; i++) {
                  var x2 = (i + j * width) * 4;
                  var weight = 0, weights = 0, weights_alpha = 0;
                  var gx_r = 0, gx_g = 0, gx_b = 0, gx_a = 0;
                  var center_y = (j + 0.5) * ratio_h;
                  var yy_start = Math.floor(j * ratio_h);
                  var yy_stop = Math.ceil((j + 1) * ratio_h);
                  for (var yy = yy_start; yy < yy_stop; yy++) {
                      var dy = Math.abs(center_y - (yy + 0.5)) / ratio_h_half;
                      var center_x = (i + 0.5) * ratio_w;
                      var w0 = dy * dy;
                      var xx_start = Math.floor(i * ratio_w);
                      var xx_stop = Math.ceil((i + 1) * ratio_w);
                      for (var xx = xx_start; xx < xx_stop; xx++) {
                          var dx = Math.abs(center_x - (xx + 0.5)) / ratio_w_half;
                          var w = Math.sqrt(w0 + dx * dx);
                          if (w >= 1) continue;
                          weight = 2 * w * w * w - 3 * w * w + 1;
                          var pos_x = 4 * (xx + yy * width_source);
                          gx_a += weight * data[pos_x + 3];
                          weights_alpha += weight;
                          if (data[pos_x + 3] < 255) weight = weight * data[pos_x + 3] / 250;
                          gx_r += weight * data[pos_x];
                          gx_g += weight * data[pos_x + 1];
                          gx_b += weight * data[pos_x + 2];
                          weights += weight;
                      }
                  }
                  data2[x2]     = gx_r / weights;
                  data2[x2 + 1] = gx_g / weights;
                  data2[x2 + 2] = gx_b / weights;
                  data2[x2 + 3] = gx_a / weights_alpha;
              }
          }

          for (var p=0; p < data2.length; p += 4) {
              var gris = data2[p];
              gris = (gris < 100) ? 0 : 255;
              data2[p] = data2[p+1] = data2[p+2] = gris;
          }
          ctx2.putImageData(img2, 0, 0);
      }

      (async () => {
          console.log("Cargando modelo...");
          modelo = await tf.loadLayersModel("model.json");
          console.log("Modelo cargado...");
      })();
    </script>
  </body>
</html>
